<h1 class="mb-4">Tu Carrito</h1>

{{#if products.length}}
<table class="table table-bordered bg-white">
  <thead class="table-dark">
    <tr>
      <th>Producto</th>
      <th>Precio</th>
      <th>Cantidad</th>
      <th>Subtotal</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="cartBody">
    {{#each products}}
      <tr data-id="{{this.product._id}}">
        <td>{{this.product.title}}</td>
        <td>${{this.product.price}}</td>
        <td class="quantity">{{this.quantity}}</td>
        <td class="subtotal">${{multiply this.product.price this.quantity}}</td>
        <td>
          <button class="btn btn-sm btn-success increment">+</button>
          <button class="btn btn-sm btn-danger decrement">-</button>
        </td>
      </tr>
    {{/each}}
  </tbody>
</table>

<h3>Total: $<span id="cartTotal">{{total}}</span></h3>

<script>
const cartId = "{{cartId}}";

async function updateCart() {
  const res = await fetch(`/api/carts/${cartId}`);
  const cart = await res.json();
  const tbody = document.getElementById("cartBody");
  tbody.innerHTML = "";

  let total = 0;

  cart.products.forEach(item => {
    const tr = document.createElement("tr");
    tr.dataset.id = item.product._id;

    const subtotal = item.product.price * item.quantity;
    total += subtotal;

    tr.innerHTML = `
      <td>${item.product.title}</td>
      <td>$${item.product.price}</td>
      <td class="quantity">${item.quantity}</td>
      <td class="subtotal">$${subtotal}</td>
      <td>
        <button class="btn btn-sm btn-success increment">+</button>
        <button class="btn btn-sm btn-danger decrement">-</button>
      </td>
    `;

    tbody.appendChild(tr);
  });

  document.getElementById("cartTotal").textContent = total;

  // Eventos para botones + y -
  document.querySelectorAll(".increment").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const pid = e.target.closest("tr").dataset.id;
      const qty = parseInt(e.target.closest("tr").querySelector(".quantity").textContent) + 1;
      await fetch(`/api/carts/${cartId}/product/${pid}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity: qty })
      });
      updateCart();
    });
  });

  document.querySelectorAll(".decrement").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const pid = e.target.closest("tr").dataset.id;
      const qty = parseInt(e.target.closest("tr").querySelector(".quantity").textContent) - 1;
      if(qty < 0) return;
      await fetch(`/api/carts/${cartId}/product/${pid}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity: qty })
      });
      updateCart();
    });
  });
}

updateCart();
</script>

{{else}}
<p>Tu carrito está vacío.</p>
{{/if}}
